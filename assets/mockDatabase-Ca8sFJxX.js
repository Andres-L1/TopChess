const p=[],c={TEACHERS:"topchess_teachers",ROOMS:"topchess_rooms"},i={initialize:()=>{localStorage.getItem(c.TEACHERS)||localStorage.setItem(c.TEACHERS,JSON.stringify(p)),localStorage.getItem(c.ROOMS)||localStorage.setItem(c.ROOMS,JSON.stringify({}))},getTeachers:()=>{const e=localStorage.getItem(c.TEACHERS);return e?JSON.parse(e):p},getTeacherById:e=>i.getTeachers().find(t=>t.id===e)||null,updateTeacher:(e,s)=>{const t=i.getTeachers(),a=t.findIndex(o=>o.id===e);return a!==-1?(t[a]={...t[a],...s},localStorage.setItem(c.TEACHERS,JSON.stringify(t)),t[a]):null},getRoom:e=>JSON.parse(localStorage.getItem(c.ROOMS)||"{}")[e]||null,updateRoom:(e,s)=>{const t=JSON.parse(localStorage.getItem(c.ROOMS)||"{}");t[e]={...t[e],...s},localStorage.setItem(c.ROOMS,JSON.stringify(t)),window.dispatchEvent(new CustomEvent("room-update",{detail:{teacherId:e,data:t[e]}}))},subscribeToRoom:(e,s)=>{const t=r=>{const n=r;n.detail.teacherId===e&&s(n.detail.data)};window.addEventListener("room-update",t);const a=r=>{if(r.key===c.ROOMS&&r.newValue)try{const l=JSON.parse(r.newValue)[e];l&&s(l)}catch(n){console.error("Error parsing storage update",n)}};window.addEventListener("storage",a);const o=i.getRoom(e);return o&&s(o),()=>{window.removeEventListener("room-update",t),window.removeEventListener("storage",a)}},createRequest:(e,s,t)=>{const a=JSON.parse(localStorage.getItem("topchess_requests")||"[]"),o=a.find(n=>n.studentId===e&&n.teacherId===s);if(o)return i.sendMessage(e,s,t,"student"),o;const r={id:Date.now().toString(),studentId:e,teacherId:s,status:"pending",timestamp:Date.now()};return a.push(r),localStorage.setItem("topchess_requests",JSON.stringify(a)),t&&i.sendMessage(e,s,t,"student"),r},getRequestStatus:(e,s)=>{const a=JSON.parse(localStorage.getItem("topchess_requests")||"[]").find(o=>o.studentId===e&&o.teacherId===s);return a?a.status:null},getRequestsForTeacher:e=>JSON.parse(localStorage.getItem("topchess_requests")||"[]").filter(t=>t.teacherId===e&&t.status==="pending"),getRequestsForStudent:e=>JSON.parse(localStorage.getItem("topchess_requests")||"[]").filter(t=>t.studentId===e),updateRequestStatus:(e,s,t)=>{const a=JSON.parse(localStorage.getItem("topchess_requests")||"[]"),o=a.findIndex(r=>r.studentId===e&&r.teacherId===s);return o!==-1?(a[o].status=t,localStorage.setItem("topchess_requests",JSON.stringify(a)),!0):!1},sendMessage:(e,s,t,a)=>{const o=JSON.parse(localStorage.getItem("topchess_messages")||"[]"),r={id:Date.now().toString()+Math.random(),studentId:e,teacherId:s,text:t,sender:a,timestamp:Date.now()};o.push(r),localStorage.setItem("topchess_messages",JSON.stringify(o)),window.dispatchEvent(new CustomEvent("chat-update",{detail:{studentId:e,teacherId:s}}))},getMessages:(e,s)=>JSON.parse(localStorage.getItem("topchess_messages")||"[]").filter(a=>a.studentId===e&&a.teacherId===s).sort((a,o)=>a.timestamp-o.timestamp),subscribeToChat:(e,s,t)=>{const a=r=>{const n=r;n.detail.studentId===e&&n.detail.teacherId===s&&t(i.getMessages(e,s))};window.addEventListener("chat-update",a);const o=r=>{r.key==="topchess_messages"&&r.newValue&&t(i.getMessages(e,s))};return window.addEventListener("storage",o),()=>{window.removeEventListener("chat-update",a),window.removeEventListener("storage",o)}},getWallet:e=>{const s=JSON.parse(localStorage.getItem("topchess_wallets")||"{}");return s[e]||(s[e]={balance:0,currency:"EUR"},localStorage.setItem("topchess_wallets",JSON.stringify(s))),s[e]},getTransactions:e=>JSON.parse(localStorage.getItem("topchess_transactions")||"[]").filter(t=>t.fromId===e||t.toId===e).sort((t,a)=>a.timestamp-t.timestamp),addFunds:(e,s)=>{const t=JSON.parse(localStorage.getItem("topchess_wallets")||"{}");t[e]||(t[e]={balance:0,currency:"EUR"}),t[e].balance+=s,localStorage.setItem("topchess_wallets",JSON.stringify(t));const a=JSON.parse(localStorage.getItem("topchess_transactions")||"[]");return a.push({id:"tx_"+Date.now(),type:"deposit",fromId:"system",toId:e,amount:s,timestamp:Date.now(),description:"Recarga de Saldo"}),localStorage.setItem("topchess_transactions",JSON.stringify(a)),window.dispatchEvent(new Event("wallet-update")),t[e]},calculateCommission:e=>{const t=JSON.parse(localStorage.getItem("topchess_requests")||"[]").filter(n=>n.teacherId===e&&n.status==="approved").length;let a=.5,o="Novato",r=3;return t>=20?(a=.85,o="Gran Maestro",r=null):t>=10?(a=.75,o="Avanzado",r=20):t>=3&&(a=.65,o="Intermedio",r=10),{rate:a,levelName:o,activeStudents:t,nextLevelStart:r,platformFee:1-a}},processPayment:(e,s,t,a)=>{const o=JSON.parse(localStorage.getItem("topchess_wallets")||"{}");if(o[e]||(o[e]={balance:0,currency:"EUR"}),o[s]||(o[s]={balance:0,currency:"EUR"}),o[e].balance<t)return{success:!1,error:"Saldo insuficiente"};const r=i.calculateCommission(s),n=t,l=t*r.rate;o[e].balance-=n,o[s].balance+=l,localStorage.setItem("topchess_wallets",JSON.stringify(o));const m=JSON.parse(localStorage.getItem("topchess_transactions")||"[]"),g=Date.now();return m.push({id:"tx_out_"+g+"_"+e,type:"payment_sent",fromId:e,toId:s,amount:-n,timestamp:g,description:a}),m.push({id:"tx_in_"+g+"_"+s,type:"payment_received",fromId:e,toId:s,amount:l,timestamp:g,description:`${a} (ComisiÃ³n ${(r.platformFee*100).toFixed(0)}% aplicada)`}),localStorage.setItem("topchess_transactions",JSON.stringify(m)),window.dispatchEvent(new Event("wallet-update")),{success:!0}},getTeacherAvailability:e=>JSON.parse(localStorage.getItem("topchess_availability")||"{}")[e]||[],updateTeacherAvailability:(e,s)=>{const t=JSON.parse(localStorage.getItem("topchess_availability")||"{}");t[e]=s,localStorage.setItem("topchess_availability",JSON.stringify(t))},getBookings:()=>JSON.parse(localStorage.getItem("topchess_bookings")||"[]"),createBooking:(e,s,t,a)=>{const o=i.getBookings();if(o.find(n=>n.teacherId===s&&n.slotId===t&&n.date===a&&n.status!=="cancelled"))return{success:!1,error:"Horario ya reservado"};const r={id:"bk_"+Date.now(),studentId:e,teacherId:s,slotId:t,date:a,status:"confirmed",timestamp:Date.now()};return o.push(r),localStorage.setItem("topchess_bookings",JSON.stringify(o)),{success:!0,booking:r}},getProfile:e=>{const t=i.getTeachers().find(o=>o.id===e);if(t)return{name:t.name,bio:t.description,image:t.image,elo:t.elo};const a=JSON.parse(localStorage.getItem("topchess_users")||"{}");return a[e]?a[e]:{name:e==="student1"?"Estudiante Demo":`User ${e}`,elo:1200,image:"https://images.unsplash.com/photo-1599566150163-29194dcaad36?ixlib=rb-1.2.1&auto=format&fit=crop&w=256&q=80",bio:"Estudiante de ajedrez apasionado."}},updateProfile:(e,s)=>{const t=i.getTeachers(),a=t.findIndex(r=>r.id===e);if(a!==-1){const r={};return s.name&&(r.name=s.name),s.bio&&(r.description=s.bio),s.image&&(r.image=s.image),s.elo&&(r.elo=s.elo),t[a]={...t[a],...r},localStorage.setItem(c.TEACHERS,JSON.stringify(t)),t[a]}const o=JSON.parse(localStorage.getItem("topchess_users")||"{}");return o[e]={...o[e]||i.getProfile(e),...s},localStorage.setItem("topchess_users",JSON.stringify(o)),window.dispatchEvent(new CustomEvent("profile-update",{detail:{userId:e,profile:o[e]}})),o[e]}};export{i as m};
