const u="topchess-app",g=window.location.origin+"/TopChess/lichess-callback",d={async getUserStudies(e,t){try{if(!e)return[];const r={};t&&(r.Authorization=`Bearer ${t}`);const s=`https://lichess.org/api/study/by/${e}`,o=await fetch(s,{headers:r});if(!o.ok)throw new Error("Error fetching studies");return(await o.text()).split(`
`).filter(c=>c.trim()).map(c=>{try{return JSON.parse(c)}catch{return null}}).filter(Boolean)}catch(r){return console.error("Lichess API Error:",r),[]}},async getStudyPgn(e,t){try{const r={};t&&(r.Authorization=`Bearer ${t}`);const s=await fetch(`https://lichess.org/api/study/${e}.pgn`,{headers:r});if(!s.ok)throw new Error("Error fetching PGN");return await s.text()}catch(r){return console.error("Lichess PGN Error:",r),""}},async exchangeCodeForToken(e,t){try{const r=new URLSearchParams({grant_type:"authorization_code",code:e,code_verifier:t,redirect_uri:g,client_id:u}),s=await fetch("https://lichess.org/api/token",{method:"POST",body:r});if(!s.ok){const a=await s.text();return console.error("Token exchange failed:",a),null}return(await s.json()).access_token}catch(r){return console.error("Lichess token error:",r),null}},async getAuthUser(e){try{const t=await fetch("https://lichess.org/api/account",{headers:{Authorization:`Bearer ${e}`}});return t.ok?await t.json():null}catch{return null}},parseChapters(e){return e.split(/\[Event /g).filter(Boolean).map(r=>{const s="[Event "+r.trim(),o=s.match(/\[Event "(.*)"\]/);return{name:o?o[1]:"Sin tÃ­tulo",pgn:s}})},sanitizePgn(e){if(!e)return"";if(e.trim().startsWith("{")&&e.trim().endsWith("}"))try{const t=JSON.parse(e);return t&&typeof t=="object"&&t.pgn?this.sanitizePgn(t.pgn):""}catch{}return e.replace(/\r/g,"").replace(/\[(LichessId|Variant|Annotator|SIT|Clock|UTCDate|UTCTime|ChapterMode) "[^"]*"\]\s*/g,"").replace(/\{\s+/g,"{ ").replace(/\s+\}/g," }").replace(/[ \t]{2,}/g," ").replace(/\n{3,}/g,`

`).trim()},parseCommentAnnotations(e){if(!e)return{text:"",shapes:[]};let t=e,r=[],s;const o=t.match(/\[%cal ([^\]]+)\]/);o&&(o[1].split(",").forEach(n=>{const l=n.charAt(0),h={G:"green",R:"red",B:"blue",Y:"yellow"}[l]||"green",i=n.substring(1,3);let p=n.substring(3,5);i&&p&&r.push({orig:i,dest:p,brush:h})}),t=t.replace(/\[%cal [^\]]+\]/,""));const a=t.match(/\[%csl ([^\]]+)\]/);return a&&(a[1].split(",").forEach(n=>{const l=n.charAt(0),h={G:"green",R:"red",B:"blue",Y:"yellow"}[l]||"green",i=n.substring(1,3);i&&r.push({orig:i,brush:h})}),t=t.replace(/\[%csl [^\]]+\]/,"")),t=t.replace(/\[%clk [^\]]+\]/g,""),t=t.replace(/\[%eval [^\]]+\]/g,""),t=t.replace(/\[%[^\]]+\]/g,""),{text:t.trim(),shapes:r,glyph:s}},getLICHESS_CLIENT_ID(){return u},getREDIRECT_URI(){return g}};export{d as l};
